<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retail Management</title>
  <link rel="icon" type="image/gif" href="https://i.giphy.com/4cJAkBS9KAOz2px44s.webp" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <script src="https://kit.fontawesome.com/46113fb541.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    @keyframes fallAndFade {
      0% {
        opacity: 1;
        transform: translateY(0);
        height: auto;
        margin-bottom: 1rem;
        padding: 0;
      }
      100% {
        opacity: 0;
        transform: translateY(50px);
        height: 0;
        margin-bottom: 0;
        padding: 0;
      }
    }
    .exam-card {
      animation: slideIn 0.3s ease-out forwards;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .exam-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .exam-card.collapsing {
      animation: fallAndFade 0.8s forwards;
      pointer-events: none;
    }
    .date-chip {
      transition: all 0.2s ease;
    }
    .date-chip:hover:not(:disabled) {
      animation: pulse 0.3s ease-in-out;
      cursor: pointer;
    }
    .date-chip:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      background-color: #f3f4f6 !important; /* Tailwind gray-100 */
      color: #9ca3af !important; /* Tailwind gray-400 */
      border-color: #d1d5db !important; /* Tailwind gray-300 */
    }
    /* Center and justify date chips */
    #dateFilters {
      justify-content: center;
    }
    .loading-spinner {
      border: 6px solid #e5e7eb;
      border-top: 6px solid #3b82f6;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    /* Divider between date and time in currentDate */
    #currentDate {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-variant-numeric: tabular-nums;
    }
    #currentDate .date-part,
    #currentDate .time-part {
      white-space: nowrap;
    }
    #currentDate .divider {
      width: 1px;
      height: 1.25rem;
      background-color: #34d399; /* green-400 */
      border-radius: 1px;
      opacity: 0.7;
    }
    /* Next exam notification base styling without depth */
    #nextExamNotification > div {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem; /* text-sm */
      border-radius: 0.375rem; /* rounded-md */
      padding: 0.5rem 1rem;
      cursor: pointer;
      user-select: none;
      overflow: hidden;
      transition: background-color 0.5s ease, color 0.5s ease;
      border: 1px solid transparent;
      box-shadow: none !important;
    }
    #nextExamNotification > div.default {
      color: #4b5563; /* gray-700 */
      background-color: #f9fafb; /* gray-50 */
      border-color: #d1d5db; /* gray-300 */
    }
    #nextExamNotification > div.hour1 {
      color: #374151; /* gray-800 */
      background-color: #e0e7ff; /* indigo-100 */
      border-color: #a5b4fc; /* indigo-300 */
    }
    #nextExamNotification > div.hour2 {
      color: #1e3a8a; /* indigo-900 */
      background-color: #c7d2fe; /* indigo-200 */
      border-color: #818cf8; /* indigo-400 */
    }
    #nextExamNotification > div.hour3 {
      color: #7c2d12; /* orange-900 */
      background-color: #fed7aa; /* orange-200 */
      border-color: #fb923c; /* orange-400 */
    }
    #nextExamNotification > div.hour4plus {
      color: #065f46; /* green-900 */
      background-color: #bbf7d0; /* green-200 */
      border-color: #34d399; /* green-400 */
    }
    /* Alert style for last 30 minutes before exam start */
    #nextExamNotification > div.alert {
      color: #b45309; /* amber-700 */
      background-color: #fef3c7; /* amber-100 */
      border-color: #fbbf24; /* amber-400 */
      animation: pulse 2s infinite ease-in-out;
      font-weight: 700;
    }
    #nextExamNotification i {
      flex-shrink: 0;
      font-size: 1.125rem; /* text-lg */
    }
    #nextExamNotification strong {
      flex-shrink: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 50vw;
    }
    #nextExamNotification span.date {
      flex: 1 1 auto;
      white-space: nowrap;
      min-width: 5rem;
    }
    #nextExamNotification span.timeleft {
      flex: 1 1 auto;
      white-space: nowrap;
      font-weight: 600;
      min-width: 7rem;
      text-align: right;
    }
    @media (min-width: 640px) {
      #nextExamNotification > div {
        flex-wrap: nowrap;
      }
      #nextExamNotification strong {
        max-width: 20rem;
        margin-left: 0.5rem;
      }
      #nextExamNotification span.date {
        min-width: auto;
        margin-left: auto;
        margin-right: 0.5rem;
        text-align: right;
      }
      #nextExamNotification span.timeleft {
        min-width: auto;
        text-align: right;
      }
    }
    @media (max-width: 639px) {
      #nextExamNotification strong {
        max-width: 60vw;
      }
      #nextExamNotification span.date,
      #nextExamNotification span.timeleft {
        min-width: auto;
        text-align: left;
      }
    }
    /* Header icon wrapper with simple orange border */
    #headerIconWrapper {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      border-radius: 0.5rem;
      border: 2px solid #f97316; /* orange-500 */
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: none;
      cursor: default;
      transition: none;
    }
    #headerIconWrapper:hover {
      box-shadow: none;
      transform: none;
    }
    #headerIcon {
      width: 36px;
      height: 36px;
      border-radius: 0.4rem;
      object-fit: cover;
      box-shadow: none;
      background: transparent;
      position: relative;
      z-index: 1;
    }
    /* Icon-based mute/unmute button for clean look and detailed presence */
    #audioControlBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: #f97316; /* orange-500 */
      background-color: transparent;
      border: none;
      border-radius: 50%;
      padding: 0;
      margin-left: 0.5rem;
      flex-shrink: 0;
      position: relative;
      transition: color 0.3s ease;
      font-size: 1.25rem;
      line-height: 1;
    }
    #audioControlBtn:hover {
      color: #c2410c; /* orange-700 */
    }
    /* Container for semester text and mute button inline */
    #semesterContainer {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.125rem; /* small spacing */
    }
    /* Retail Management text with new cool mixed gradient */
    #retailTitle {
      background: linear-gradient(90deg, #06b6d4, #3b82f6, #9333ea);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      font-weight: 700;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
  <div class="min-h-screen flex flex-col" id="app">
    <header class="bg-white shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <div id="headerIconWrapper" aria-label="Retail Management logo with simple orange border" role="img">
              <img id="headerIcon" src="https://i.giphy.com/4cJAkBS9KAOz2px44s.webp" alt="Animated gif icon showing a colorful swirling pattern with bright neon colors in motion" />
            </div>
            <div class="flex flex-col leading-tight">
              <h1 id="retailTitle" class="text-2xl select-text">
                Retail Management
              </h1>
              <div id="semesterContainer">
                <p class="text-sm text-gray-500 select-text m-0">4th SEMESTER (जय श्री राम)</p>
                <button id="audioControlBtn" aria-label="Mute audio" title="Mute audio" type="button" tabindex="0" aria-pressed="false">
                  <i class="fa-solid fa-volume-high" aria-hidden="true"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row sm:items-center gap-3 w-full sm:w-auto">
            <div id="currentDate" class="inline-flex items-center rounded-full bg-green-100 text-green-700 px-3 py-1 font-semibold text-sm select-none whitespace-nowrap shadow-sm" aria-live="polite" aria-atomic="true">
              <i class="far fa-calendar-alt mr-2" aria-hidden="true"></i>
              <span class="date-part">Loading...</span>
              <span class="divider" aria-hidden="true"></span>
              <span class="time-part"></span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <section id="nextExamNotification" class="max-w-6xl mx-auto mt-3 px-4">
      <div role="link" tabindex="0" aria-live="polite" aria-label="Next exam notification" class="default">
        <i class="fas fa-bell" aria-hidden="true"></i>
        <strong class="truncate">Loading next exam...</strong>
        <span class="date"></span>
        <span class="timeleft"></span>
      </div>
    </section>

    <main class="max-w-6xl mx-auto px-4 py-8 flex-grow">
      <div id="dateFilters" class="flex flex-wrap gap-2 mb-6"></div>
      <div id="examList" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="noResults" class="hidden text-center py-12">
        <div class="text-gray-400 text-6xl mb-4">
          <i class="fas fa-search" aria-hidden="true"></i>
        </div>
        <p class="text-gray-500 text-lg">No exams found matching your search.</p>
      </div>
    </main>
  </div>

  <script>
    (() => {
      const examSchedule = [
        {
          date: "22-04-2025",
          day: "Tuesday",
          time: "2pm to 5pm",
          paper: "Supply Chain Management (SCM)",
          code: "ARM-S-447-B",
          path: "https://telegra.ph/androidneeds-03-02",
          color: "bg-blue-100 border-blue-300",
          icon: "truck",
        },
        {
          date: "23-04-2025",
          day: "Wednesday",
          time: "2pm to 5pm",
          paper: "Visual Merchandising (VM)",
          code: "ARM-S-448-B",
          path: "https://telegra.ph/How-to-Make-Your-Own-Hand-Sanitizer-04-25",
          color: "bg-pink-100 border-pink-300",
          icon: "paint-brush",
        },
        {
          date: "24-04-2025",
          day: "Thursday",
          time: "2pm to 5pm",
          paper: "E-Retailing (ER)",
          code: "ARM-S-449-B",
          path: "https://telegra.ph/Fraudsters-Try-To-Scam-PM-CARES-Donors-With-Fake-UPI-ID-03-31",
          color: "bg-purple-100 border-purple-300",
          icon: "shopping-cart",
        },
        {
          date: "25-04-2025",
          day: "Friday",
          time: "2pm to 5pm",
          paper: "Marketing Research (MR)",
          code: "ARM-S-450-B",
          path: "https://telegra.ph/Top-sites-for-career-04-11",
          color: "bg-green-100 border-green-300",
          icon: "chart-bar",
        },
        {
          date: "28-04-2025",
          day: "Monday",
          time: "2pm to 5pm",
          paper: "International Retailing and Bench Mark Retailers (IR & BR)",
          code: "ARM-S-451-B",
          path: "https://telegra.ph/The-Deverakonda-Foundation-04-26",
          color: "bg-yellow-100 border-yellow-300",
          icon: "globe",
        },
        {
          date: "29-04-2025",
          day: "Tuesday",
          time: "2pm to 5pm",
          paper: "Multi Brand Retailing (MBR)",
          code: "ARM-S-452-B",
          path: "https://telegra.ph/Projects-to-do-04-12",
          color: "bg-indigo-100 border-indigo-300",
          icon: "store",
        },
        {
          date: "30-04-2025",
          day: "Wednesday",
          time: "2pm to 5pm",
          paper: "Retail Communications (RC)",
          code: "ARM-S-453-B",
          path: "https://telegra.ph/Big-news-03-30",
          color: "bg-red-100 border-red-300",
          icon: "comments",
        },
      ];

      let searchTerm = "";
      let selectedDate = null;

      const dateFilters = document.getElementById("dateFilters");
      const examList = document.getElementById("examList");
      const noResults = document.getElementById("noResults");
      const currentDateEl = document.getElementById("currentDate");
      const currentDatePart = currentDateEl.querySelector(".date-part");
      const currentTimePart = currentDateEl.querySelector(".time-part");
      const nextExamNotification = document.getElementById("nextExamNotification");
      const nextExamDiv = nextExamNotification.querySelector("div");
      const nextExamStrong = nextExamDiv.querySelector("strong");
      const nextExamDateSpan = nextExamDiv.querySelector("span.date");
      const nextExamTimeLeftSpan = nextExamDiv.querySelector("span.timeleft");

      // Audio setup
      const audio = new Audio("https://od.lk/s/NDJfNDc5ODM4ODZf/AUD-20250422-WA0027.mp3");
      audio.volume = 0.2;
      audio.preload = "auto";
      audio.autoplay = true;
      audio.loop = false;
      audio.muted = false;

      // Play audio immediately on page load, ignoring autoplay restrictions
      window.addEventListener("load", () => {
        // Try to play audio immediately
        audio.play().catch(() => {
          // If autoplay blocked, unmute and play on first user interaction
          function userInteract() {
            audio.muted = false;
            audio.play().catch(() => {});
            window.removeEventListener("click", userInteract);
            window.removeEventListener("keydown", userInteract);
            window.removeEventListener("touchstart", userInteract);
          }
          window.addEventListener("click", userInteract);
          window.addEventListener("keydown", userInteract);
          window.addEventListener("touchstart", userInteract);
        });
      });

      // Mute/unmute button
      const audioControlBtn = document.getElementById("audioControlBtn");

      function updateAudioButton() {
        if (audio.muted || audio.volume === 0) {
          audioControlBtn.setAttribute("aria-label", "Unmute audio");
          audioControlBtn.setAttribute("title", "Unmute audio");
          audioControlBtn.setAttribute("aria-pressed", "true");
          audioControlBtn.innerHTML = `<i class="fa-solid fa-volume-xmark" aria-hidden="true"></i>`;
        } else {
          audioControlBtn.setAttribute("aria-label", "Mute audio");
          audioControlBtn.setAttribute("title", "Mute audio");
          audioControlBtn.setAttribute("aria-pressed", "false");
          audioControlBtn.innerHTML = `<i class="fa-solid fa-volume-high" aria-hidden="true"></i>`;
        }
      }

      audioControlBtn.addEventListener("click", () => {
        if (audio.muted || audio.volume === 0) {
          audio.muted = false;
          if (audio.paused) {
            audio.play().catch(() => {});
          }
        } else {
          audio.muted = true;
        }
        updateAudioButton();
      });

      // Keyboard accessibility for button
      audioControlBtn.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          audioControlBtn.click();
        }
      });

      // Initialize audio button state
      updateAudioButton();

      // Helper: parse exam end datetime (5pm on exam date)
      function getExamEndDateTime(exam) {
        const [dd, mm, yyyy] = exam.date.split("-");
        // 17:00:00 is 5pm
        return new Date(`${yyyy}-${mm}-${dd}T17:00:00`);
      }

      // Helper: parse exam start datetime (2pm on exam date)
      function getExamStartDateTime(exam) {
        const [dd, mm, yyyy] = exam.date.split("-");
        // 14:00:00 is 2pm
        return new Date(`${yyyy}-${mm}-${dd}T14:00:00`);
      }

      function filterExams() {
        const term = searchTerm.toLowerCase();
        return examSchedule.filter(
          (exam) =>
            (exam.paper.toLowerCase().includes(term) ||
              exam.date.includes(term) ||
              exam.day.toLowerCase().includes(term) ||
              exam.code.toLowerCase().includes(term)) &&
            (!selectedDate || exam.date === selectedDate)
        );
      }

      function renderDateFilters() {
        const uniqueDates = [...new Set(examSchedule.map((exam) => exam.date))];
        const now = new Date();

        dateFilters.innerHTML = "";
        uniqueDates.forEach((date) => {
          // Find exam(s) on this date to check if all passed
          const examsOnDate = examSchedule.filter(e => e.date === date);
          // If all exams on this date have ended (past 5pm), disable button
          const allPassed = examsOnDate.every(exam => getExamEndDateTime(exam) < now);

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = `date-chip px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
            selectedDate === date
              ? "bg-orange-600 text-white"
              : "bg-white hover:bg-orange-50 text-gray-700"
          } border border-orange-300`;
          btn.textContent = date;
          btn.setAttribute("aria-pressed", selectedDate === date);
          if (allPassed) {
            btn.disabled = true;
          } else {
            btn.disabled = false;
            btn.addEventListener("click", () => {
              selectedDate = selectedDate === date ? null : date;
              render();
            });
          }
          dateFilters.appendChild(btn);
        });
      }

      function renderExams() {
        const filteredExams = filterExams();
        const now = new Date();
        examList.innerHTML = "";

        if (filteredExams.length === 0) {
          noResults.classList.remove("hidden");
          return;
        } else {
          noResults.classList.add("hidden");
        }

        filteredExams.forEach((exam, index) => {
          const examEnd = getExamEndDateTime(exam);
          const isPast = examEnd < now;
          const twoHoursAfterEnd = new Date(examEnd.getTime() + 2 * 60 * 60 * 1000);
          const shouldCollapse = now >= twoHoursAfterEnd;

          const card = document.createElement("div");
          card.className = `exam-card ${exam.color} border rounded-lg overflow-hidden`;
          card.style.animationDelay = `${index * 0.1}s`;

          if (shouldCollapse) {
            card.classList.add("collapsing");
            // Remove from DOM after animation ends to avoid layout issues
            card.addEventListener("animationend", () => {
              if (card.parentNode) {
                card.parentNode.removeChild(card);
              }
              // If no cards remain, show noResults
              if (examList.children.length === 0) {
                noResults.classList.remove("hidden");
              }
            });
          } else if (isPast) {
            card.classList.add("opacity-50");
          }

          const link = document.createElement("a");
          link.href = exam.path;
          link.className = "block p-4 hover:bg-white/50 transition-colors";
          link.setAttribute("tabindex", "0");
          link.setAttribute("target", "_blank");
          link.setAttribute("rel", "noopener noreferrer");
          if (isPast && !shouldCollapse) {
            // Disable link if exam passed but not collapsed yet
            link.classList.remove("hover:bg-white/50");
            link.style.cursor = "not-allowed";
            link.onclick = e => e.preventDefault();
          } else if (!shouldCollapse) {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              // Animate fade out then open link in new tab
              document.getElementById("app").classList.add("opacity-0");
              setTimeout(() => {
                window.open(exam.path, "_blank", "noopener,noreferrer");
                document.getElementById("app").classList.remove("opacity-0");
              }, 100);
            });
          }

          const flexDiv = document.createElement("div");
          flexDiv.className = "flex items-center gap-4";

          const iconDiv = document.createElement("div");
          iconDiv.className =
            "flex-shrink-0 w-10 h-10 rounded-full bg-white/80 flex items-center justify-center";
          const icon = document.createElement("i");
          icon.className = `fas fa-${exam.icon} text-gray-700`;
          icon.setAttribute("aria-hidden", "true");
          iconDiv.appendChild(icon);

          const infoDiv = document.createElement("div");
          infoDiv.className = "flex-1 min-w-0";

          const titleRow = document.createElement("div");
          titleRow.className = "flex items-baseline justify-between gap-2";

          const title = document.createElement("h3");
          title.className = "text-lg font-semibold text-gray-900 truncate";
          title.textContent = exam.paper;

          titleRow.appendChild(title);

          const subRow = document.createElement("div");
          subRow.className = "flex items-center gap-3 mt-1";

          const daySpan = document.createElement("span");
          daySpan.className = "text-sm text-gray-600";
          daySpan.textContent = exam.day;

          const codeSpan = document.createElement("span");
          codeSpan.className = "text-sm text-gray-500";
          codeSpan.textContent = exam.code;

          subRow.appendChild(daySpan);
          subRow.appendChild(codeSpan);

          infoDiv.appendChild(titleRow);
          infoDiv.appendChild(subRow);

          const chevron = document.createElement("i");
          chevron.className = "fas fa-chevron-right text-gray-400";
          chevron.setAttribute("aria-hidden", "true");

          flexDiv.appendChild(iconDiv);
          flexDiv.appendChild(infoDiv);
          flexDiv.appendChild(chevron);

          link.appendChild(flexDiv);
          card.appendChild(link);
          examList.appendChild(card);
        });
      }

      function updateCurrentDate() {
        const now = new Date();
        const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        const optionsTime = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
        const dateStr = now.toLocaleDateString(undefined, optionsDate);
        const timeStr = now.toLocaleTimeString(undefined, optionsTime);
        currentDatePart.textContent = dateStr;
        currentTimePart.textContent = timeStr;
      }

      function getNextExam() {
        const now = new Date();
        // Parse exam dates and find the next exam date/time >= now (2pm to 5pm)
        const upcomingExams = examSchedule
          .map(exam => {
            const [dd, mm, yyyy] = exam.date.split("-");
            // Exam start and end datetime
            const examStart = new Date(`${yyyy}-${mm}-${dd}T14:00:00`);
            const examEnd = new Date(`${yyyy}-${mm}-${dd}T17:00:00`);
            return { ...exam, examStart, examEnd };
          })
          .filter(exam => exam.examEnd >= now)
          .sort((a, b) => a.examStart - b.examStart);

        return upcomingExams.length > 0 ? upcomingExams[0] : null;
      }

      // Format time left as "X days HH:mm:ss"
      function formatTimeLeft(ms) {
        if (ms <= 0) return "0s";
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        let result = "";
        if (days > 0) result += days + (days === 1 ? " day " : " days ");
        result +=
          (hours < 10 ? "0" : "") + hours + ":" +
          (minutes < 10 ? "0" : "") + minutes + ":" +
          (seconds < 10 ? "0" : "") + seconds;
        return result;
      }

      let nextExamInterval = null;

      function updateNextExamNotification() {
        const nextExam = getNextExam();
        if (!nextExam) {
          nextExamStrong.textContent = "No upcoming exams";
          nextExamDateSpan.textContent = "";
          nextExamTimeLeftSpan.textContent = "";
          nextExamDiv.className = "default";
          nextExamDiv.classList.remove("alert");
          nextExamDiv.classList.remove("hour1", "hour2", "hour3", "hour4plus");
          nextExamDiv.classList.remove("cursor-pointer");
          nextExamDiv.removeAttribute("role");
          nextExamDiv.removeAttribute("tabindex");
          nextExamDiv.onclick = null;
          nextExamDiv.onkeypress = null;
          if (nextExamInterval) {
            clearInterval(nextExamInterval);
            nextExamInterval = null;
          }
          return;
        }

        function updateTimeLeft() {
          const now = new Date();
          let timeLeftMs;
          let label;
          if (now < nextExam.examStart) {
            timeLeftMs = nextExam.examStart - now;
            label = "Starts in";
          } else if (now >= nextExam.examStart && now <= nextExam.examEnd) {
            timeLeftMs = nextExam.examEnd - now;
            label = "Ends in";
          } else {
            // Exam passed, clear interval and rerender
            clearInterval(nextExamInterval);
            nextExamInterval = null;
            render();
            return;
          }
          const timeLeftStr = formatTimeLeft(timeLeftMs);
          const options = { weekday: 'short', month: 'short', day: 'numeric' };
          const examDateStr = nextExam.examStart.toLocaleDateString(undefined, options);
          nextExamStrong.textContent = nextExam.paper;
          nextExamDateSpan.textContent = examDateStr;
          nextExamTimeLeftSpan.textContent = `${label}: ${timeLeftStr}`;

          // Update color class based on hours passed since now to exam start
          const msToStart = nextExam.examStart - now;
          const hoursToStart = msToStart / (1000 * 60 * 60);

          // Remove all color classes first
          nextExamDiv.classList.remove("hour1", "hour2", "hour3", "hour4plus", "alert", "default");

          if (label === "Starts in" && msToStart <= 30 * 60 * 1000 && msToStart > 0) {
            // Alert style for last 30 minutes before exam start
            nextExamDiv.classList.add("alert");
          } else if (label === "Starts in" && msToStart > 0) {
            // Change color every hour passed, counting down from exam start
            if (hoursToStart <= 1) {
              nextExamDiv.classList.add("hour1");
            } else if (hoursToStart <= 2) {
              nextExamDiv.classList.add("hour2");
            } else if (hoursToStart <= 3) {
              nextExamDiv.classList.add("hour3");
            } else {
              nextExamDiv.classList.add("hour4plus");
            }
          } else {
            // During exam or after start, use default style
            nextExamDiv.classList.add("default");
          }
        }

        nextExamDiv.classList.add("cursor-pointer");
        nextExamDiv.setAttribute("role", "link");
        nextExamDiv.setAttribute("tabindex", "0");
        nextExamDiv.setAttribute("aria-label", `Next exam is ${nextExam.paper} on ${nextExam.examStart.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}, click to open details`);
        nextExamDiv.onclick = () => {
          window.open(nextExam.path, "_blank", "noopener,noreferrer");
        };
        nextExamDiv.onkeypress = (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            nextExamDiv.click();
          }
        };

        updateTimeLeft();
        if (nextExamInterval) clearInterval(nextExamInterval);
        nextExamInterval = setInterval(updateTimeLeft, 1000);
      }

      function scheduleNextUpdate() {
        const now = new Date();
        const next5pm = new Date(now);
        next5pm.setHours(17, 0, 0, 0);
        if (now >= next5pm) {
          // If current time is after 5pm, schedule for next day 5pm
          next5pm.setDate(next5pm.getDate() + 1);
        }
        const msUntilNext5pm = next5pm - now;
        setTimeout(() => {
          updateNextExamNotification();
          scheduleNextUpdate();
        }, msUntilNext5pm);
      }

      // Periodically check for collapsing cards every minute
      function startCollapseChecker() {
        setInterval(() => {
          const now = new Date();
          const cards = Array.from(examList.children);
          cards.forEach(card => {
            if (card.classList.contains("collapsing")) return; // Already collapsing
            const paper = card.querySelector("h3")?.textContent;
            if (!paper) return;
            const exam = examSchedule.find(e => e.paper === paper);
            if (!exam) return;
            const examEnd = getExamEndDateTime(exam);
            const twoHoursAfterEnd = new Date(examEnd.getTime() + 2 * 60 * 60 * 1000);
            if (now >= twoHoursAfterEnd) {
              card.classList.add("collapsing");
              card.addEventListener("animationend", () => {
                if (card.parentNode) {
                  card.parentNode.removeChild(card);
                }
                if (examList.children.length === 0) {
                  noResults.classList.remove("hidden");
                }
              });
            }
          });
        }, 60000); // every 60 seconds
      }

      function render() {
        renderDateFilters();
        renderExams();
        updateNextExamNotification();
      }

      // Initial render
      render();
      updateCurrentDate();
      setInterval(updateCurrentDate, 1000);
      scheduleNextUpdate();
      startCollapseChecker();
    })();
  </script>
</body>
</html>
